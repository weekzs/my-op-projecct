<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="å®æ³¢-ä¹æ±Ÿæ™ºèƒ½éª‘è¡ŒåŠ©æ‰‹ - å®æ—¶å¯¼èˆªã€å¤©æ°”é¢„è­¦ã€ä½å®¿è§„åˆ’">
    <meta name="theme-color" content="#2196F3">
    <title>ğŸš´ å®æ³¢-ä¹æ±Ÿæ™ºèƒ½éª‘è¡ŒåŠ©æ‰‹</title>
    
    <!-- å¤©åœ°å›¾API - å»¶è¿ŸåŠ è½½ -->
    <script type="text/javascript">
        // å¤©åœ°å›¾APIåŠ è½½çŠ¶æ€ç›‘æ§
        window.tiandituLoadStatus = {
            loaded: false,
            error: false,
            retryCount: 0,
            maxRetries: 3
        };

        // åŠ è½½å¤©åœ°å›¾API
        function loadTiandituAPI() {
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://api.tianditu.gov.cn/api?v=4.0&tk=b9dba51939890c06d308032e54dd8c71';
            
            script.onload = function() {
                console.log('âœ“ å¤©åœ°å›¾APIè„šæœ¬åŠ è½½æˆåŠŸ');
                window.tiandituLoadStatus.loaded = true;
                
                // éªŒè¯Tå¯¹è±¡æ˜¯å¦å¯ç”¨
                if (typeof T !== 'undefined') {
                    console.log('âœ“ Tå¯¹è±¡å¯ç”¨ï¼Œç‰ˆæœ¬:', T.VERSION || '4.0');
                } else {
                    console.warn('âš ï¸ è„šæœ¬åŠ è½½æˆåŠŸä½†Tå¯¹è±¡ä¸å¯ç”¨');
                }
            };
            
            script.onerror = function() {
                console.error('âŒ å¤©åœ°å›¾APIè„šæœ¬åŠ è½½å¤±è´¥');
                window.tiandituLoadStatus.error = true;
                
                // é‡è¯•æœºåˆ¶
                if (window.tiandituLoadStatus.retryCount < window.tiandituLoadStatus.maxRetries) {
                    window.tiandituLoadStatus.retryCount++;
                    console.log(`å°è¯•é‡æ–°åŠ è½½ (${window.tiandituLoadStatus.retryCount}/${window.tiandituLoadStatus.maxRetries})`);
                    setTimeout(loadTiandituAPI, 2000);
                } else {
                    console.error('âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œå¤©åœ°å›¾APIåŠ è½½å¤±è´¥');
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    document.getElementById('map-loading').innerHTML = `
                        <div style="text-align: center; color: #F44336;">
                            <p style="font-size: 18px;">âŒ</p>
                            <p>åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>
                            <button onclick="loadTiandituAPI()" style="margin-top: 10px; padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                é‡æ–°åŠ è½½
                            </button>
                        </div>
                    `;
                }
            };
            
            document.head.appendChild(script);
        }

        // é¡µé¢åŠ è½½æ—¶å¼€å§‹åŠ è½½API
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸŒ å¼€å§‹åŠ è½½å¤©åœ°å›¾API...');
            loadTiandituAPI();
        });
    </script>
    
    <!-- æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- PWAé…ç½® -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- å›¾æ ‡ -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192x192.png">
</head>
<body>
    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="app" class="app-container">
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <header class="status-header">
            <div class="status-left">
                <span id="current-location" class="location-status">
                    ğŸ“ <span class="status-text">å®šä½ä¸­...</span>
                </span>
            </div>
            <div class="status-center">
                <h1 class="app-title">ğŸš´ å®æ³¢â†’ä¹æ±Ÿ</h1>
            </div>
            <div class="status-right">
                <span id="battery-status" class="battery-status">
                    ğŸ”‹ <span class="status-text">--%</span>
                </span>
            </div>
        </header>

        <!-- è¿›åº¦æ¦‚è§ˆæ  -->
        <section class="progress-overview">
            <div class="progress-item">
                <div class="progress-label">ä»Šæ—¥è¿›åº¦</div>
                <div class="progress-value">
                    <span id="today-distance">0</span> / <span id="target-distance">120</span> km
                </div>
                <div class="progress-bar">
                    <div id="distance-progress" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
            <div class="progress-item">
                <div class="progress-label">å¹³å‡é€Ÿåº¦</div>
                <div class="progress-value">
                    <span id="average-speed">0</span> km/h
                </div>
            </div>
            <div class="progress-item">
                <div class="progress-label">é¢„è®¡åˆ°è¾¾</div>
                <div class="progress-value">
                    <span id="eta">--:--</span>
                </div>
            </div>
        </section>

        <!-- å¯¼èˆªæ˜¾ç¤ºåŒºåŸŸ -->
        <main class="map-section">
            <div id="map-container" class="map-container">
                <div id="tianditu-map" class="tianditu-map"></div>
                
                <!-- å¯¼èˆªä¿¡æ¯å åŠ å±‚ -->
                <div id="navigation-overlay" class="navigation-overlay" style="display: none;">
                    <!-- å½“å‰è½¬å‘æŒ‡ç¤º -->
                    <div class="turn-indicator">
                        <div id="turn-arrow" class="turn-arrow">â¬†ï¸</div>
                        <div id="turn-distance" class="turn-distance">200m</div>
                        <div id="turn-instruction" class="turn-instruction">ç›´è¡Œ</div>
                    </div>
                    
                    <!-- è·¯å†µä¿¡æ¯æ¡ -->
                    <div id="traffic-bar" class="traffic-bar">
                        <div class="traffic-status">
                            <span id="traffic-indicator" class="traffic-indicator smooth"></span>
                            <span id="traffic-text">è·¯å†µç•…é€š</span>
                        </div>
                        <div class="speed-info">
                            <span id="current-speed">0</span> km/h
                        </div>
                    </div>
                    
                    <!-- ETAä¿¡æ¯ -->
                    <div class="eta-info">
                        <div class="eta-item">
                            <span class="eta-label">å‰©ä½™</span>
                            <span id="nav-distance">--km</span>
                        </div>
                        <div class="eta-item">
                            <span class="eta-label">é¢„è®¡</span>
                            <span id="nav-time">--:--</span>
                        </div>
                        <div class="eta-item">
                            <span class="eta-label">åˆ°è¾¾</span>
                            <span id="nav-arrival">--:--</span>
                        </div>
                    </div>
                </div>
                
                <!-- åœ°å›¾æ§åˆ¶æŒ‰é’® -->
                <div class="map-controls">
                    <button id="current-location-btn" class="map-btn" title="å›åˆ°å½“å‰ä½ç½®">
                        ğŸ“
                    </button>
                    <button id="toggle-route-btn" class="map-btn" title="æ˜¾ç¤º/éšè—è·¯çº¿">
                        ğŸ›£ï¸
                    </button>
                    <button id="toggle-accommodation-btn" class="map-btn" title="æ˜¾ç¤º/éšè—ä½å®¿">
                        ğŸ¨
                    </button>
                    <button id="fullscreen-btn" class="map-btn" title="å…¨å±">
                        ğŸ”³
                    </button>
                </div>
                
                <!-- åœ°å›¾åŠ è½½çŠ¶æ€ -->
                <div id="map-loading" class="map-loading">
                    <div class="loading-spinner"></div>
                    <p>åœ°å›¾åŠ è½½ä¸­...</p>
                </div>
            </div>
        </main>

        <!-- å¯¼èˆªæ§åˆ¶åŒºåŸŸ -->
        <section class="navigation-control">
            <div class="nav-card" id="navigation-card">
                <div class="nav-header">
                    <h3>ğŸ§­ å¯¼èˆªæ§åˆ¶</h3>
                    <div class="nav-status-indicator" id="nav-status">
                        <span class="status-dot inactive"></span>
                        <span class="status-text">æœªå¼€å§‹</span>
                    </div>
                </div>
                
                <div class="nav-content" id="nav-content">
                    <!-- å¯¼èˆªçŠ¶æ€æ˜¾ç¤º -->
                    <div class="nav-status-display">
                        <div class="status-row">
                            <span class="label">çŠ¶æ€:</span>
                            <span id="nav-current-status">æœªå¼€å§‹å¯¼èˆª</span>
                        </div>
                        <div class="status-row">
                            <span class="label">è·¯çº¿:</span>
                            <span id="nav-route-info">å®æ³¢ â†’ ä¹æ±Ÿ</span>
                        </div>
                        <div class="status-row">
                            <span class="label">è¿›åº¦:</span>
                            <div class="progress-mini">
                                <div id="nav-progress-bar" class="progress-mini-fill" style="width: 0%"></div>
                            </div>
                            <span id="nav-progress-text">0%</span>
                        </div>
                    </div>
                    
                    <!-- å¯¼èˆªæ§åˆ¶æŒ‰é’® -->
                    <div class="nav-controls">
                        <button id="start-navigation" class="btn btn-nav btn-start-nav">
                            â–¶ï¸ å¼€å§‹å¯¼èˆª
                        </button>
                        <button id="stop-navigation" class="btn btn-nav btn-stop-nav" disabled>
                            â¹ï¸ åœæ­¢å¯¼èˆª
                        </button>
                        <button id="pause-navigation" class="btn btn-nav btn-pause-nav" disabled>
                            â¸ï¸ æš‚åœ
                        </button>
                        <button id="reroute" class="btn btn-nav btn-secondary" disabled>
                            ğŸ”„ é‡æ–°è§„åˆ’
                        </button>
                    </div>
                    
                    <!-- è¯­éŸ³æ§åˆ¶ -->
                    <div class="voice-control">
                        <label class="switch">
                            <input type="checkbox" id="voice-toggle" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="voice-label">è¯­éŸ³å¯¼èˆª</span>
                        <button id="test-voice" class="btn btn-voice-test">
                            ğŸ”Š æµ‹è¯•
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- AIæ™ºèƒ½å»ºè®®åŒºåŸŸ -->
        <section class="ai-suggestions">
            <div class="suggestion-card" id="ai-recommendation">
                <div class="suggestion-header">
                    <h3>ğŸ¤– AIæ™ºèƒ½å»ºè®®</h3>
                    <span id="suggestion-time" class="suggestion-time">--:--</span>
                </div>
                <div class="suggestion-content" id="suggestion-content">
                    <div class="suggestion-loading">
                        <div class="loading-dots">
                            <span></span><span></span><span></span>
                        </div>
                        <p>AIæ­£åœ¨åˆ†ææ‚¨çš„éª‘è¡ŒçŠ¶æ€...</p>
                    </div>
                </div>
                <div class="suggestion-actions">
                    <button id="accept-suggestion" class="btn btn-primary" disabled>
                        âœ“ é‡‡çº³å»ºè®®
                    </button>
                    <button id="modify-suggestion" class="btn btn-secondary" disabled>
                        âš™ï¸ è°ƒæ•´æ–¹æ¡ˆ
                    </button>
                    <button id="emergency-help" class="btn btn-emergency">
                        ğŸ†˜ ç´§æ€¥æ±‚åŠ©
                    </button>
                </div>
            </div>
        </section>

        <!-- å¿«é€Ÿä¿¡æ¯é¢æ¿ -->
        <section class="quick-info">
            <div class="info-grid">
                <!-- å¤©æ°”ä¿¡æ¯ -->
                <div class="info-card weather-card">
                    <div class="info-header">
                        <h4>ğŸŒ¤ï¸ å¤©æ°”</h4>
                        <button id="refresh-weather" class="refresh-btn" title="åˆ·æ–°å¤©æ°”">
                            ğŸ”„
                        </button>
                    </div>
                    <div class="info-content">
                        <div id="current-weather" class="weather-current">
                            <div class="weather-loading">åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                </div>

                <!-- ä½å®¿ä¿¡æ¯ -->
                <div class="info-card accommodation-card">
                    <div class="info-header">
                        <h4>ğŸ¨ ä½å®¿</h4>
                        <button id="find-accommodation" class="refresh-btn" title="æŸ¥æ‰¾ä½å®¿">
                            ğŸ”
                        </button>
                    </div>
                    <div class="info-content">
                        <div id="next-accommodation" class="accommodation-next">
                            <div class="accommodation-loading">æ™ºèƒ½æ¨èä¸­...</div>
                        </div>
                    </div>
                </div>

                <!-- ä½“åŠ›çŠ¶æ€ -->
                <div class="info-card fitness-card">
                    <div class="info-header">
                        <h4>ğŸ’ª ä½“åŠ›çŠ¶æ€</h4>
                    </div>
                    <div class="info-content">
                        <div id="fitness-status" class="fitness-status">
                            <div class="fitness-indicator" id="fitness-indicator">
                                <div class="fitness-fill" style="width: 100%"></div>
                            </div>
                            <div class="fitness-text">çŠ¶æ€è‰¯å¥½</div>
                        </div>
                    </div>
                </div>

                <!-- è·¯å†µä¿¡æ¯ -->
                <div class="info-card road-card">
                    <div class="info-header">
                        <h4>ğŸ›£ï¸ è·¯å†µ</h4>
                    </div>
                    <div class="info-content">
                        <div id="road-condition" class="road-condition">
                            <div class="road-status">æ­£å¸¸</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- åº•éƒ¨æ§åˆ¶æ  -->
        <footer class="bottom-controls">
            <div class="control-group">
                <button id="start-trip" class="btn btn-control btn-start">
                    â–¶ï¸ å¼€å§‹è¡Œç¨‹
                </button>
                <button id="pause-trip" class="btn btn-control btn-pause" disabled>
                    â¸ï¸ æš‚åœ
                </button>
                <button id="rest-stop" class="btn btn-control btn-rest">
                    â˜• ä¼‘æ¯
                </button>
            </div>
            <div class="control-group">
                <button id="settings" class="btn btn-control">
                    âš™ï¸ è®¾ç½®
                </button>
                <button id="history" class="btn btn-control">
                    ğŸ“Š ç»Ÿè®¡
                </button>
            </div>
        </footer>
    </div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div id="settings-panel" class="panel-overlay" style="display: none;">
        <div class="panel-content">
            <div class="panel-header">
                <h3>âš™ï¸ è®¾ç½®</h3>
                <button id="close-settings" class="close-btn">Ã—</button>
            </div>
            <div class="panel-body">
                <div class="setting-group">
                    <label for="daily-budget">æ¯æ—¥é¢„ç®—ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="daily-budget" value="100" min="50" max="500">
                </div>
                <div class="setting-group">
                    <label for="preferred-start-time">åå¥½å‡ºå‘æ—¶é—´</label>
                    <input type="time" id="preferred-start-time" value="08:00">
                </div>
                <div class="setting-group">
                    <label for="riding-style">éª‘è¡Œé£æ ¼</label>
                    <select id="riding-style">
                        <option value="conservative">ä¿å®ˆå‹</option>
                        <option value="balanced" selected>å¹³è¡¡å‹</option>
                        <option value="aggressive">æ¿€è¿›å‹</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="accommodation-type">ä½å®¿åå¥½</label>
                    <select id="accommodation-type">
                        <option value="budget" selected>è¶…ç»æµå‹</option>
                        <option value="economy">ç»æµå‹</option>
                        <option value="comfort">èˆ’é€‚å‹</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="auto-adjustment">
                        <input type="checkbox" id="auto-adjustment" checked>
                        å¯ç”¨è‡ªåŠ¨è°ƒæ•´å»ºè®®
                    </label>
                </div>
                <div class="setting-group">
                    <label for="emergency-contact">ç´§æ€¥è”ç³»äºº</label>
                    <input type="tel" id="emergency-contact" placeholder="è¾“å…¥ç”µè¯å·ç ">
                </div>
                <button id="save-settings" class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <!-- ç´§æ€¥æ±‚åŠ©é¢æ¿ -->
    <div id="emergency-panel" class="panel-overlay" style="display: none;">
        <div class="panel-content emergency-content">
            <div class="panel-header emergency-header">
                <h3>ğŸ†˜ ç´§æ€¥æ±‚åŠ©</h3>
                <button id="close-emergency" class="close-btn">Ã—</button>
            </div>
            <div class="panel-body">
                <div class="emergency-location">
                    <h4>ğŸ“ å½“å‰ä½ç½®</h4>
                    <p id="emergency-coords">è·å–ä¸­...</p>
                    <button id="share-location" class="btn btn-primary">åˆ†äº«ä½ç½®</button>
                </div>
                <div class="emergency-actions">
                    <h4>ğŸš¨ ç´§æ€¥æ“ä½œ</h4>
                    <button id="call-emergency" class="btn btn-emergency-large">ğŸ“ æ‹¨æ‰“ç´§æ€¥ç”µè¯</button>
                    <button id="find-nearby-help" class="btn btn-secondary">ğŸ” æŸ¥æ‰¾é™„è¿‘å¸®åŠ©</button>
                    <button id="start-sos" class="btn btn-sos">â–¶ï¸ å¯åŠ¨SOSæ¨¡å¼</button>
                </div>
                <div class="emergency-contacts">
                    <h4>ğŸ‘¥ ç´§æ€¥è”ç³»äºº</h4>
                    <div id="emergency-contacts-list" class="contacts-list">
                        <!-- åŠ¨æ€ç”Ÿæˆè”ç³»äººåˆ—è¡¨ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScriptæ–‡ä»¶ -->
    <script src="js/config.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/map.js"></script>
    <script src="js/location.js"></script>
    <script src="js/weather.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/ai-assistant.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/traffic-monitor.js"></script>
    <script src="js/app.js"></script>

    <!-- æœåŠ¡æ³¨å†Œï¼ˆPWAï¼‰ -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }
    </script>
</body>
</html>