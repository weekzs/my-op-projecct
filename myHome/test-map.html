<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©åœ°å›¾APIæµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 500px;
            border: 2px solid #ccc;
            margin: 20px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>ğŸ—ºï¸ å¤©åœ°å›¾APIæµ‹è¯•é¡µé¢</h1>
    
    <div id="status" class="status info">
        æ­£åœ¨æµ‹è¯•å¤©åœ°å›¾APIåŠ è½½çŠ¶æ€...
    </div>
    
    <div>
        <button onclick="testBasicMap()">åŸºç¡€åœ°å›¾æµ‹è¯•</button>
        <button onclick="testWithKey()">ä½¿ç”¨APIå¯†é’¥æµ‹è¯•</button>
        <button onclick="testDifferentLayers()">æµ‹è¯•ä¸åŒå›¾å±‚</button>
        <button onclick="testLocation()">è·å–å½“å‰ä½ç½®</button>
    </div>
    
    <div id="map"></div>
    
    <div id="debug-info" style="background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px;">
        <h3>è°ƒè¯•ä¿¡æ¯ï¼š</h3>
        <pre id="debug-content">ç­‰å¾…æµ‹è¯•...</pre>
    </div>

    <!-- æ–¹æ¡ˆ1ï¼šåŸºç¡€å¤©åœ°å›¾API -->
    <script type="text/javascript">
        let map = null;
        let testResults = [];

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateDebug(content) {
            const debugContent = document.getElementById('debug-content');
            debugContent.textContent = content;
        }

        function logDebug(message) {
            testResults.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            updateDebug(testResults.join('\n'));
        }

        // æµ‹è¯•åŸºç¡€åœ°å›¾åŠ è½½
        function testBasicMap() {
            logDebug('å¼€å§‹æµ‹è¯•åŸºç¡€åœ°å›¾...');
            
            // æ£€æŸ¥Tå¯¹è±¡æ˜¯å¦å­˜åœ¨
            if (typeof T !== 'undefined') {
                logDebug('âœ“ å¤©åœ°å›¾APIå·²åŠ è½½');
                updateStatus('å¤©åœ°å›¾APIåŠ è½½æˆåŠŸ', 'success');
                
                try {
                    // åˆ›å»ºåœ°å›¾å®ä¾‹
                    map = new T.Map('map');
                    logDebug('âœ“ åœ°å›¾å®ä¾‹åˆ›å»ºæˆåŠŸ');
                    
                    // è®¾ç½®ä¸­å¿ƒç‚¹å’Œç¼©æ”¾çº§åˆ«
                    const center = new T.LngLat(116.404, 39.915);
                    map.centerAndZoom(center, 12);
                    logDebug('âœ“ åœ°å›¾ä¸­å¿ƒè®¾ç½®æˆåŠŸ: åŒ—äº¬å¤©å®‰é—¨');
                    
                    // æ·»åŠ ç¼©æ”¾æ§ä»¶
                    map.addControl(new T.Control.Zoom());
                    logDebug('âœ“ ç¼©æ”¾æ§ä»¶æ·»åŠ æˆåŠŸ');
                    
                    updateStatus('åŸºç¡€åœ°å›¾æµ‹è¯•æˆåŠŸï¼', 'success');
                    
                } catch (error) {
                    logDebug(`âœ— åœ°å›¾åˆ›å»ºå¤±è´¥: ${error.message}`);
                    updateStatus(`åœ°å›¾åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                logDebug('âœ— å¤©åœ°å›¾APIæœªåŠ è½½');
                updateStatus('å¤©åœ°å›¾APIåŠ è½½å¤±è´¥', 'error');
            }
        }

        // ä½¿ç”¨APIå¯†é’¥æµ‹è¯•
        function testWithKey() {
            logDebug('å¼€å§‹æµ‹è¯•å¸¦APIå¯†é’¥çš„åœ°å›¾...');
            
            // é‡æ–°åŠ è½½å¸¦APIå¯†é’¥çš„è„šæœ¬
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://api.tianditu.gov.cn/api?v=4.0&tk=b9dba51939890c06d308032e54dd8c71';
            script.onload = function() {
                logDebug('âœ“ å¸¦å¯†é’¥çš„å¤©åœ°å›¾APIåŠ è½½æˆåŠŸ');
                
                if (map) {
                    map.destroy();
                }
                
                try {
                    map = new T.Map('map');
                    const center = new T.LngLat(121.5440, 29.8683); // å®æ³¢
                    map.centerAndZoom(center, 10);
                    
                    // æ·»åŠ å›¾å±‚
                    const vecLayer = new T.TileLayer.wmts();
                    map.addLayer(vecLayer);
                    logDebug('âœ“ çŸ¢é‡å›¾å±‚æ·»åŠ æˆåŠŸ');
                    
                    const cvaLayer = new T.TileLayer.wmts({
                        layer: 'cva',
                        style: 'default'
                    });
                    map.addLayer(cvaLayer);
                    logDebug('âœ“ æ³¨è®°å›¾å±‚æ·»åŠ æˆåŠŸ');
                    
                    // æ·»åŠ æ ‡è®°
                    const marker = new T.Marker(center);
                    map.addOverLay(marker);
                    logDebug('âœ“ æ ‡è®°æ·»åŠ æˆåŠŸ: å®æ³¢');
                    
                    updateStatus('APIå¯†é’¥æµ‹è¯•æˆåŠŸï¼', 'success');
                    
                } catch (error) {
                    logDebug(`âœ— APIå¯†é’¥æµ‹è¯•å¤±è´¥: ${error.message}`);
                    updateStatus(`APIå¯†é’¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            };
            script.onerror = function() {
                logDebug('âœ— å¸¦å¯†é’¥çš„APIåŠ è½½å¤±è´¥');
                updateStatus('å¸¦APIå¯†é’¥çš„APIåŠ è½½å¤±è´¥', 'error');
            };
            
            document.head.appendChild(script);
        }

        // æµ‹è¯•ä¸åŒå›¾å±‚
        function testDifferentLayers() {
            if (!map) {
                updateStatus('è¯·å…ˆåˆ›å»ºåœ°å›¾', 'error');
                return;
            }
            
            logDebug('å¼€å§‹æµ‹è¯•ä¸åŒå›¾å±‚...');
            
            try {
                // å«æ˜Ÿå›¾
                const satLayer = new T.TileLayer.wmts({
                    layer: 'img',
                    style: 'default'
                });
                map.addLayer(satLayer);
                logDebug('âœ“ å«æ˜Ÿå›¾å±‚æ·»åŠ æˆåŠŸ');
                
                // åœ°å½¢å›¾
                const terLayer = new T.TileLayer.wmts({
                    layer: 'ter',
                    style: 'default'
                });
                logDebug('âœ“ åœ°å½¢å›¾å±‚å‡†å¤‡æˆåŠŸ');
                
                updateStatus('å›¾å±‚æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                logDebug(`âœ— å›¾å±‚æµ‹è¯•å¤±è´¥: ${error.message}`);
                updateStatus(`å›¾å±‚æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å®šä½åŠŸèƒ½
        function testLocation() {
            logDebug('å¼€å§‹æµ‹è¯•å®šä½åŠŸèƒ½...');
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        logDebug(`âœ“ è·å–ä½ç½®æˆåŠŸ: ${lat}, ${lng}`);
                        
                        if (map) {
                            const currentLocation = new T.LngLat(lng, lat);
                            map.centerAndZoom(currentLocation, 15);
                            
                            // æ·»åŠ å½“å‰ä½ç½®æ ‡è®°
                            const marker = new T.Marker(currentLocation);
                            map.addOverLay(marker);
                            
                            logDebug('âœ“ å½“å‰ä½ç½®æ ‡è®°æ·»åŠ æˆåŠŸ');
                            updateStatus(`å®šä½æˆåŠŸï¼å½“å‰ä½ç½®: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'success');
                        }
                    },
                    function(error) {
                        logDebug(`âœ— å®šä½å¤±è´¥: ${error.message}`);
                        updateStatus(`å®šä½å¤±è´¥: ${error.message}`, 'error');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                logDebug('âœ— æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½');
                updateStatus('æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½', 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            logDebug('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹APIæ£€æµ‹...');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰Tå¯¹è±¡
            setTimeout(() => {
                if (typeof T !== 'undefined') {
                    logDebug('âœ“ æ£€æµ‹åˆ°å¤©åœ°å›¾APIå¯¹è±¡');
                    updateStatus('å¤©åœ°å›¾APIå·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'success');
                } else {
                    logDebug('âœ— æœªæ£€æµ‹åˆ°å¤©åœ°å›¾APIå¯¹è±¡');
                    updateStatus('å¤©åœ°å›¾APIæœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                }
            }, 2000);
        };

        // é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            logDebug(`JavaScripté”™è¯¯: ${event.message} at ${event.filename}:${event.lineno}`);
        });
    </script>

    <!-- æ–¹æ¡ˆ2ï¼šå¸¦APIå¯†é’¥çš„å¤©åœ°å›¾API -->
    <script type="text/javascript" src="https://api.tianditu.gov.cn/api?v=4.0&tk=b9dba51939890c06d308032e54dd8c71"></script>
</body>
</html>